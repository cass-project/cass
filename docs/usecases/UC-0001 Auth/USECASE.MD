UC-0001 Авторизация
===================
Исполнители
-----------

 - Вячеслав Савушкин *(разработка)*
 
Описание
--------

1. Пользователь должен иметь возможность либо авторизоваться с помощью логина/пароля, либо с помощью наиболее популярных
среди русскоязычных пользователей сервисов, таких как ВК, Google, Facebook, Одноклассники и Яндекс.

Основной сценарий
-----------------

1. В любом месте проекта отображается блок с ссылками на авторизацию и регистрацию

   1.1 Если посетитель не авторизован, то отображаются две ссылки: "Sign Up" (регистрация) и "Sign In" (вход)

   1.2 Если посетитель авторизован, то отображается только ссылка "Sign Out" (выход).

2. При клике на ссылку "Sign In" посетитель переходит на адрес /auth/sign-in/, где ему отображается форма авторизации.

   2.1 Форма состоит из инпутов логина и пароля, блока иконок с ссылками на авторизацию с помощью социальных сетей и кнопки "Sign In"

   2.2 В форме должна быть ссылка, которая возвращает пользователя на предыдущую страницу ("I don't want to sign in"), если 
 данное возможно. Если возврат на предыдущую страницу невозможен, должен происходить переход на главную страницу.

3. Когда пользователь нажимает на Sign In, должна произойти попытка авторизоваться с указанными логином-паролем

   3.1 Если пользователь не заполнил поле "Email", то под полем логина должно отобразиться красным текстом: "Email can't be blank"

   3.2 Если пользователь не заполнил поле "Password", то под полем пароля должно отобразиться красным текстом: "Password can't be blank"

   3.3 Если попытка авторизации провалилась, то пользователь вверху формы должно отобразиться сообщение: "Incorrect username or password."
 
   3.4 Если попытка авторизации завершилась успешно, пользователь возвращается на предыдущую страницу в случае, если данное возможно. 
 Если переход на предыдущую страницу невозможен, должен происходить переход на главную страницу. 
 
4. Когда пользователь нажимает на Sign Out, то происходит переход *с обновлением* на главную страницу, а данные об авторизации удаляются.
Пользователь вновь отображается блок "Sign Up / Sign In".

Авторизация должны быть доступна с помощью следующих социальных сетей
---------------------------------------------------------------------

- Google

- Twitter

- GitHub

Регистрация пользователя
------------------------

1. Посетитель должен иметь возможность регистрации на нашем ресурсе

   1.1 При клике на ссылку "Sign Up" пользователю отображается форма регистрации

   1.2 Форма регистрации состоит из инпутов логина, пароля и повтора пароля и кнопка "Sign Up", которая осуществляет отправку формы.

   1.3 В форме должен отображаться блок с ссылками на авторизацию с помощью социальных сетей

   1.4 В форме должна быть ссылка, которая возвращает пользователя на предыдущую страницу ("I don't want to sign in"), если
данное возможно. Если возврат на предыдущую страницу невозможен, должен происходить переход на главную страницу.

2. После того, как пользователь заполнил все данные, ему должны появиться возможность попытки зарегистрироваться на ресурсе.

   2.1 Если пользователь не заполнил поле "Email", то под полем логина должно отобразиться красным текстом: "Email can't be blank"

   2.2 Если пользователь не заполнил поле "Password", то под полем пароля должно отобразиться красным текстом: "Password can't be blank"

   2.3 Если пользователь не заполнил поле "Repeat password", то под полем пароля должно отобразиться красным текстом: "Password can't be blank"

   2.4 При вводе логина должна происходить проверка, если логин уже занят. Если логин занят, то под полем логина должно отобразиться красным текстом: "Username is already taken"

   2.5 Если регистрация пользователя прошла успешна, то должен происходить переход *с обновлением* на главную страницу.

Тесты
-----

1. При повторной авторизации с помощью социальных сетей не должно появляться дубликатов авторизаций в базе данных.

2. Нельзя регистрировать пользователей с уже существующим логином.

3. Нельзя произвести повторную авторизацию до тех пор, пока пользователь не нажал Sign Out либо не истекло время сессии (т.е. 2 (двух) часов с времени последнего REST-запроса на сервер).


Технические детали:
------------------

1. Авторизация должна быть сделана с помощью OAuth2.

2. Необходимо защитить все без исключения запросы с URL, совпадающие с маской */\/backend/api/protected/(.*)/*,
возвращая 403 ошибку всем неавтоаризованным пользователям.

3. Попытка авторизации происходит с помощью REST-запроса на URL /backend/api/auth/attempt/ с нужными данными.

  3.1 Если авторизация прошла успешно, то json-ответ должен иметь примерно следующий вид:
```
  {
    "success": true
  }
```
 
  3.2 Если же авторизация провалилась, то json-ответ должен иметь следующий вид: 
```
  {
    "success": false
  }
```

4. Попытка регистрации происходит с помощью REST-запроса на URL /backend/api/auth/register с нужными данными.

  4.1 Если регистрация прошла успешна, то ответ должен выглядеть примерно так:
```
   {
    "success": true,
    "api_key": "..." // API KEY
   }
```
  4.2 Если регистрация не прошла успешна, то ответ должен выглядеть примерно так:
```
   {
    "success": false,
   }
```
5. Не забудьте описать REST-запросы в документации! (см. Swagger)

6. Мы заранее думаем об интернационализации, поэтому все элементы интерфейса должны быть написаны на английском.
Поддержка русского будет включена во вторую либо третью итерацию.

7. Форма авторизации подразумевает возможность перехода на предыдущую страницу, если данное поведение возможно.
Необходимо на фронтенде написать сервис с методом `сanBackToThisURL(url)`, который возвращает true, если возврат на 
данную страницу возможен, и false в ином случае. Метод должен быть пессимистичным - по умолчанию предполагается, что возврат
на страницу невозможен, если явно не указано обратного (с помощью регулярок или еще чего).

Анонимный пользователь
----------------------
1. Некоторые действия в проекте могут быть выполнены анонимно. Для этого в системе должны существовать специальный 
анонимный пользователь.
2. На бэкенде должен быть доступен специальный сервис `Anonymous`, который возвращает профиль анонимного пользователя.
3. Сервис `CurrentAccountService` по-прежнему должен возвращать ошибку при попытке получения аккаунта текущего 
пользователя при отсутствии аутентификации.

Дополнительно
-------------

- OpenID: [http://openid.net/](), [https://ru.wikipedia.org/wiki/OpenID]()

- Различие между роутингом и пайпами: [http://zend-expressive.readthedocs.org/en/latest/features/router/piping/#when-to-pipe]()

- Angular.js, HTTP-интерцептор: с помощью них можно добавить к каждому REST-запросу API-ключ. Для примера см. [http://onehungrymind.com/winning-http-interceptors-angularjs/]()