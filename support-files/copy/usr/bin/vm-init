#!/usr/bin/env bash

# sudo apt-get install language-pack-en language-pack-en-base -y
# sudo LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php

# ###############
# APT-GET SECTION
# ###############
sudo add-apt-repository ppa:ondrej/php -y
sudo apt-get update
sudo apt-get install -y php7.0 php7.0-fpm
sudo apt-get install -y php7.0-mysql php7.0-zip php7.0-curl php7.0-xml php7.0-gd php7.0-bcmath php7.0-mbstring php7.0-dom
sudo apt-get install -y git npm nginx nginx-extras sphinxsearch rabbitmq-server sendmail

# ##########
# UPDATE NPM
# ##########
sudo npm cache clean -f
sudo npm install -g n
sudo n stable

# #####
# MYSQL
# #####
sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password password 1234'
sudo debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password 1234'
sudo apt-get install mysql-client mysql-server -y

mysql -uroot -p"1234" -e "CREATE DATABASE cass_development"

# #####
# MONGO
# #####

sudo apt-get install mongodb -y
sudo npm install -g mongo-express

# #############
# MONGO-EXPRESS
# #############
sudo mkdir /opt/mongo-express
sudo chown vagrant /opt/mongo-express
cd /opt/mongo-express
npm install mongo-express

# #######
# Backend
# #######

cd /vagrant/backend/

# Install composer.phar
curl -sS https://getcomposer.org/installer | php
chmod a+x composer.phar
sudo mv composer.phar /usr/bin/
sudo ln -s /usr/bin/composer.phar /usr/bin/composer

# Install composer dependencies
composer.phar install
cp phinx.yml.dist phinx.yml
vendor/bin/phinx migrate

# ########
# Frontend
# ########
cd /vagrant/frontend

sudo ln -s /usr/bin/nodejs /usr/bin/node

sudo npm install -g typings webpack
npm install --no-bin-link
npm rebuild node-sass
typings install

webpack

# #######
# SWAGGER
# #######
sudo mkdir /opt/swagger
sudo chown vagrant /opt/swagger
cd /opt/swagger
sudo rm -rf swagger-ui/
git clone https://github.com/swagger-api/swagger-ui.git
cd swagger-ui
npm install
npm run build

#########
# PHPUNIT
#########
cd /vagrant/backend
wget https://phar.phpunit.de/phpunit.phar
chmod +x phpunit.phar
sudo mv phpunit.phar /usr/local/bin/phpunit

# #############
# Update server
# #############
/support-files/copy/usr/bin/vm-server-update

sudo update-rc.d -f amqp-listner defaults

# ###############
# Update vm-tools
# ###############
sudo chmod a+x /usr/bin/vm-server-update
sudo chmod a+x /usr/bin/vm-project-update
sudo chmod a+x /usr/bin/vm-init
sudo chmod a+x /usr/bin/vm-db-test
sudo chmod a+x /usr/bin/vm-db-recreate

# ##########
# vm-db-test
# ##########
vm-db-test